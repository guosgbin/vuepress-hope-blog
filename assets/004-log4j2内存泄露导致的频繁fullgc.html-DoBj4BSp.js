import{_ as a}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as t,b as r,o as s}from"./app-B6zx7rvj.js";const i="/assets/image-20240301122232905-DPS7j19B.png",l="/assets/image-20240301122412468-U-Jxgjwb.png",o="/assets/image-20240301142204610-BIRCo_XL.png",n="/assets/image-20240301142914193-ClrRwEqN.png",p="/assets/image-20240301142815763-LiHDRKv2.png",g="/assets/image-20240301143518060-BUMvmgk1.png",c="/assets/image-20240301153345137-BTrmg7bW.png",m="/assets/image-20240301154038886-CsfyOZWJ.png",u="/assets/image-20240301154444481-BBuc7DMx.png",d={};function h(_,e){return s(),t("div",null,e[0]||(e[0]=[r('<h2 id="ç°è±¡" tabindex="-1"><a class="header-anchor" href="#ç°è±¡"><span>ç°è±¡</span></a></h2><p>çº¿ä¸ŠæœåŠ¡çªç„¶å‘ç”Ÿé¢‘ç¹çš„ Full GCï¼Œå¹¶ä¸”æ¯æ¬¡ Full GC ååªå›æ”¶ä¸€ç‚¹ç‚¹å†…å­˜ï¼Œè€å¹´ä»£çš„å†…å­˜ä½¿ç”¨ç‡ä¸é™ã€‚</p><ul><li>é¢‘ç¹å‘ç”Ÿ Full GC ğŸ‘‡ğŸ»</li></ul><img src="'+i+'" alt="image-20240301122232905" style="zoom:100%;"><ul><li>æ¯æ¬¡ Full GC è€å¹´ä»£åªå›æ”¶äº†ä¸€ç‚¹ç‚¹å†…å­˜ ğŸ‘‡ğŸ»</li></ul><img src="'+l+'" alt="image-20240301122412468" style="zoom:100%;"><h2 id="æ’æŸ¥æ–¹å‘" tabindex="-1"><a class="header-anchor" href="#æ’æŸ¥æ–¹å‘"><span>æ’æŸ¥æ–¹å‘</span></a></h2><p>ç¬¬ä¸€æ—¶é—´ä¸‹è½½ dump çš„ prof æ–‡ä»¶ï¼Œå¹¶å¯¹å°†è¯¥æœåŠ¡å™¨çš„æµé‡åˆ‡èµ°ã€‚</p><h2 id="é—®é¢˜æ’æŸ¥å’Œåˆ†æ" tabindex="-1"><a class="header-anchor" href="#é—®é¢˜æ’æŸ¥å’Œåˆ†æ"><span>é—®é¢˜æ’æŸ¥å’Œåˆ†æ</span></a></h2><h3 id="å®šä½ä¸šåŠ¡ä»£ç " tabindex="-1"><a class="header-anchor" href="#å®šä½ä¸šåŠ¡ä»£ç "><span>å®šä½ä¸šåŠ¡ä»£ç </span></a></h3><p>visualVm å‘ç°å¤§é‡ char[]ã€‚æŒ‰å¤§å°æ’åºï¼Œå‰é¢éƒ¨åˆ†åŸºæœ¬éƒ½æ˜¯å­˜å‚¨çš„ log æ—¥å¿—ï¼Œå¤§å°éƒ½å¥½å‡ å…†ï¼Œæ€€ç–‘æ˜¯æ‰“äº†å¤§æ—¥å¿—æœ‰å…³ï¼Œæ’æŸ¥ç›¸å…³ä¸šåŠ¡ï¼Œå…³é—­äº†ä¸€äº›ä¸åˆç†çš„æ—¥å¿—ã€‚</p><img src="'+o+'" alt="image-20240301142204610" style="zoom:100%;"><p>å°†å…¶ä¸­ä¸€ä¸ªchar[] æ•°ç»„çš„å†…å®¹æ‹¿å‡ºæ¥çœ‹ä¸€ä¸‹ï¼š</p><img src="'+n+'" alt="image-20240301142914193"><p>å¯¹åº”çš„ä»£ç å¦‚ä¸‹ï¼š</p><img src="'+p+'" alt="image-20240301142815763"><p>ä»ä»£ç ä¸­çœ‹åˆ°ï¼Œè¿™æ¡æ—¥å¿—å¹¶ä¸é•¿ï¼Œä¸ºå•¥è¿™ä¸ª char[] å´å¥½å‡ mï¼Œè€Œä¸” unansweredCnt:0 åé¢çš„æ—¥å¿—æ˜æ˜¾è·Ÿå‰é¢çš„æ¥ä¸ä¸Š, éšä¾¿æ‰¾äº†å…¶ä»–çš„char[] ä¹Ÿæœ‰è¿™ç§æƒ…å†µã€‚</p><h3 id="åˆ†æå¼•ç”¨é“¾è·¯" tabindex="-1"><a class="header-anchor" href="#åˆ†æå¼•ç”¨é“¾è·¯"><span>åˆ†æå¼•ç”¨é“¾è·¯</span></a></h3><p>é€šè¿‡ referencesï¼Œåˆ†æå¼•ç”¨é“¾è·¯</p><img src="'+g+'" alt="image-20240301143518060"><p>å‘ç°æ—¥å¿—æœ€ç»ˆç¼“å­˜åˆ° StringBuilderï¼Œè€Œè¿™ä¸ª StringBuilder å­˜å‚¨åˆ°äº†çº¿ç¨‹çš„ ThreadLocal é‡Œé¢å»äº†ã€‚</p><p>æœç´¢ Log4j2 åœ¨ä»€ä¹ˆåœ°æ–¹ä½¿ç”¨äº† StringBuilderï¼Œæ’æŸ¥å‘ç° org.apache.logging.log4j.message.ParameterizedMessage è¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ªå¤ç”¨ StringBuilder çš„ä»£ç ï¼Œçº¿ä¸Šä½¿ç”¨ log4j-api çš„ç‰ˆæœ¬æ˜¯ 2.6.1</p><img src="'+c+'" alt="image-20240301153345137"><p>è¿™æ®µä»£ç ä¸­ Log4j2 å¼•ç”¨äº†ä¸€ä¸ª ThreadLocal ä¸­çš„ StringBuilderï¼Œè¿™æ ·å¤ç”¨ StringBuilder å¯ä»¥å¤§å¹…æé«˜æ—¥å¿—è¾“å‡ºæ•ˆç‡ï¼Œä½†æ˜¯è¿™æ®µä»£ç  buffer.setLength(0)ï¼Œè¿™ä¸ªæ“ä½œåªä¼šå°† StringBuilder çš„å†™å…¥é‡ç½®ä¸ºä» 0 å¼€å§‹å†™å…¥ï¼Œä½†ä¸ä¼šå›æ”¶ StringBuilder å·²ç»å ç”¨çš„å†…å­˜ï¼Œç”±äºå½“å‰çš„ ThreadLocal æ˜¯ tomcat çš„çº¿ç¨‹æ± é‡Œçš„çº¿ç¨‹ï¼Œçº¿ç¨‹ä¸€èˆ¬ä¸ä¼šé”€æ¯ï¼Œæ‰€ä»¥ ThreadLocal å°±åŸºæœ¬æ²¡å•¥å¯èƒ½ä¼šè¢«é‡Šæ”¾ï¼Œå¯¼è‡´StringBuilder ä¹Ÿä¸ä¼šè¢«å›æ”¶ã€‚è¿™ä¸ª StringBuilder çš„å†…å­˜åªä¼šå¢åŠ ä¸ä¼šå‡å°‘ï¼Œç”±æ­¤å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</p><h2 id="é—®é¢˜è§£å†³" tabindex="-1"><a class="header-anchor" href="#é—®é¢˜è§£å†³"><span>é—®é¢˜è§£å†³</span></a></h2><p>æŸ¥çœ‹å®˜ç½‘å‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ª bugï¼Œå…·ä½“åœ°å€å¦‚ä¸‹ï¼š<a href="https://issues.apache.org/jira/browse/LOG4J2-1858" target="_blank" rel="noopener noreferrer">https://issues.apache.org/jira/browse/LOG4J2-1858</a></p><p>ç„¶å log4j å®˜æ–¹åœ¨ 2.9.0 ç‰ˆæœ¬ä¿®å¤äº†è¿™ä¸ª bugï¼Œ release note åœ°å€ï¼š<a href="https://logging.apache.org/log4j/2.x/release-notes.html" target="_blank" rel="noopener noreferrer">https://logging.apache.org/log4j/2.x/release-notes.html</a></p><img src="'+m+'" alt="image-20240301154038886" style="zoom:100%;"><p>æˆ‘ä»¬å†³å®šå‡çº§åˆ° 2.12.1</p><img src="'+u+'" alt="image-20240301154444481" style="zoom:100%;"><p>å¯ä»¥çœ‹åˆ°æ–°ç‰ˆæœ¬ä¸­å¢åŠ ä¸€ä¸ªæ“ä½œtrimToMaxSizeï¼Œå½“ buffer çš„é•¿åº¦å¤§äºæŸä¸€ç›´æ—¶ä¼šè§¦å‘ StringBuilder çš„ trimToSize æ“ä½œï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå›æ”¶ StringBuilder çš„ç¼“å­˜ã€‚</p><h2 id="ç»“è®º" tabindex="-1"><a class="header-anchor" href="#ç»“è®º"><span>ç»“è®º</span></a></h2><p>1ã€æŸäº›ä¸šåŠ¡æ‰“å°äº†å¤§é‡å¤§æ—¥å¿—ï¼Œå¯¼è‡´æ¯ä¸ªçº¿ç¨‹ threadLocal çš„ StringBuilder å ç”¨å†…å­˜å¢å¤§ï¼Œæœ€å¤§è¾¾åˆ° 5mï¼›</p><p>2ã€ç›®å‰ç³»ç»Ÿå¸¸é©»çº¿ç¨‹ç¨³å®šåœ¨ 6000~7000ï¼Œæœ€ç»ˆæ—¥å¿— buffer å°±ä¼šå åˆ° 3~4gï¼›</p><p>3ã€è§„èŒƒæ—¥å¿—è¾“å‡ºï¼Œé¿å…ç£ç›˜ã€å†…å­˜æµªè´¹ï¼›</p><p>4ã€å‡çº§ log4j2 ç‰ˆæœ¬ï¼Œä» 2.6.1 åˆ° 2.12.1ï¼›</p>',36)]))}const b=a(d,[["render",h]]),j=JSON.parse('{"path":"/business_issue_accumulations/004-log4j2%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E5%AF%BC%E8%87%B4%E7%9A%84%E9%A2%91%E7%B9%81fullgc.html","title":"004-log4j2å†…å­˜æ³„éœ²å¯¼è‡´é¢‘ç¹fullgc","lang":"en-US","frontmatter":{"title":"004-log4j2å†…å­˜æ³„éœ²å¯¼è‡´é¢‘ç¹fullgc","description":"ç°è±¡ çº¿ä¸ŠæœåŠ¡çªç„¶å‘ç”Ÿé¢‘ç¹çš„ Full GCï¼Œå¹¶ä¸”æ¯æ¬¡ Full GC ååªå›æ”¶ä¸€ç‚¹ç‚¹å†…å­˜ï¼Œè€å¹´ä»£çš„å†…å­˜ä½¿ç”¨ç‡ä¸é™ã€‚ é¢‘ç¹å‘ç”Ÿ Full GC ğŸ‘‡ğŸ» image-20240301122232905 æ¯æ¬¡ Full GC è€å¹´ä»£åªå›æ”¶äº†ä¸€ç‚¹ç‚¹å†…å­˜ ğŸ‘‡ğŸ» image-20240301122412468 æ’æŸ¥æ–¹å‘ ç¬¬ä¸€æ—¶é—´ä¸‹è½½ dump çš„ prof...","head":[["meta",{"property":"og:url","content":"https://blog.guosgbin.cn/business_issue_accumulations/004-log4j2%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2%E5%AF%BC%E8%87%B4%E7%9A%84%E9%A2%91%E7%B9%81fullgc.html"}],["meta",{"property":"og:title","content":"004-log4j2å†…å­˜æ³„éœ²å¯¼è‡´é¢‘ç¹fullgc"}],["meta",{"property":"og:description","content":"ç°è±¡ çº¿ä¸ŠæœåŠ¡çªç„¶å‘ç”Ÿé¢‘ç¹çš„ Full GCï¼Œå¹¶ä¸”æ¯æ¬¡ Full GC ååªå›æ”¶ä¸€ç‚¹ç‚¹å†…å­˜ï¼Œè€å¹´ä»£çš„å†…å­˜ä½¿ç”¨ç‡ä¸é™ã€‚ é¢‘ç¹å‘ç”Ÿ Full GC ğŸ‘‡ğŸ» image-20240301122232905 æ¯æ¬¡ Full GC è€å¹´ä»£åªå›æ”¶äº†ä¸€ç‚¹ç‚¹å†…å­˜ ğŸ‘‡ğŸ» image-20240301122412468 æ’æŸ¥æ–¹å‘ ç¬¬ä¸€æ—¶é—´ä¸‹è½½ dump çš„ prof..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"property":"og:updated_time","content":"2025-04-03T07:07:29.000Z"}],["meta",{"property":"article:modified_time","content":"2025-04-03T07:07:29.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"004-log4j2å†…å­˜æ³„éœ²å¯¼è‡´é¢‘ç¹fullgc\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2025-04-03T07:07:29.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"è¶…å¨è“çŒ« Dylan Kwok\\",\\"url\\":\\"\\",\\"email\\":\\"guosgbin@163.com\\"}]}"]]},"git":{"createdTime":1743664049000,"updatedTime":1743664049000,"contributors":[{"name":"Dylan Kwok","username":"","email":"guosgbin@163.com","commits":1}]},"readingTime":{"minutes":2.82,"words":845},"filePathRelative":"business_issue_accumulations/004-log4j2å†…å­˜æ³„éœ²å¯¼è‡´çš„é¢‘ç¹fullgc.md","localizedDate":"April 3, 2025","autoDesc":true}');export{b as comp,j as data};
